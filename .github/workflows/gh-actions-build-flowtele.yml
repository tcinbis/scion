name: Build Flowtele Action
on: [push]
jobs:
  Build-Project:
    runs-on: ubuntu-18.04
    steps:
      - name: Who am I? ðŸ”Ž
        run: id
      - name: Setup Go environment
        uses: actions/setup-go@v2.1.3
        with:
          go-version: 1.14
          stable: true
      - name: Check out repository code
        uses: actions/checkout@v2
      - name: Install docker and bazel
        run: sudo bash ${{ github.workspace }}/tools/install_docker && sudo bash ${{ github.workspace }}/tools/install_bazel && bash ${{ github.workspace }}/scion.sh bazel_remote
      - name: Installing project deps
        run: sudo DEBIAN_FRONTEND=noninteractive apt install make capnproto bridge-utils build-essential capnproto cgroup-tools curl g++ gcc git jq make moreutils net-tools python3-pip python3-setuptools python3-wheel software-properties-common sqlite3 sudo tzdata zlib1g-dev -y && mkdir -p /home/runner/.local && sudo chown -R runner:runner /home/runner/.local&& pip3 install -r ${{ github.workspace }}/env/pip3/requirements.txt
      - name: Cache build results
        uses: actions/cache@v2.1.5
        with:
          path: |
            ${{ github.workspace }}/bazel-bin
            ${{ github.workspace }}/bazel-out
            ${{ github.workspace }}/bazel-scion
          key: ${{ runner.os }}-build-${{ github.ref }}
      - name: Run make all
        run: make -C ${{ github.workspace }} all
      - name: Upload a Build Artifact
        uses: actions/upload-artifact@v2.2.3
        with:
          name: flowtele-artifacts
          path: ${{ github.workspace }}/bazel-bin/go/flowtele
